# Hodor AI Code Review for GitLab CI
#
# Automatically reviews merge requests and posts comments using AI-powered analysis.
# Hodor uses 'glab' (GitLab CLI) internally for API operations.
#
# üìã Setup Instructions:
# 1. Set required CI/CD variables (Settings ‚Üí CI/CD ‚Üí Variables):
#    - LLM_API_KEY (or ANTHROPIC_API_KEY/OPENAI_API_KEY): Your LLM API key
#    - GITLAB_TOKEN: Personal/Project access token with 'api' scope
#
# 2. (Optional) Set these variables for customization:
#    - HODOR_MODEL: Model to use (default: anthropic/claude-sonnet-4-5-20250929)
#      Recommended: anthropic/claude-sonnet-4-20250514, anthropic/claude-sonnet-4-5-20250929,
#                   openai/gpt-5-2025-08-07, gemini/gemini-2.5-pro, deepseek/deepseek-chat
#    - HODOR_VERBOSE: Set to "true" for detailed logs
#
# üîê Token Authentication Options:
#
# Option A: Personal/Project Access Token (DEFAULT - see hodor-review job below)
#   - Create at: Settings ‚Üí Access Tokens
#   - Required scope: 'api' or 'read_api' + 'write_repository'
#   - Store as: GITLAB_TOKEN in CI/CD variables
#   - ‚úÖ Works with ALL GitLab API endpoints
#   - ‚úÖ Reliable for posting comments
#
# Option B: CI Job Token (ALTERNATIVE - see hodor-review-job-token below)
#   - Automatically available as $CI_JOB_TOKEN (no manual setup)
#   - ‚úÖ More secure (auto-rotating, job-scoped)
#   - ‚úÖ No need to store tokens in CI/CD variables
#   - ‚ö†Ô∏è LIMITED: Only certain API endpoints support job tokens
#   - ‚ö†Ô∏è May not support all comment posting operations
#   - üìö See: https://docs.gitlab.com/ee/ci/jobs/ci_job_token.html
#   - üí° To use: Comment out 'hodor-review', uncomment 'hodor-review-job-token'
#
# üìö Full Documentation: https://github.com/mr-karan/hodor/blob/main/docs/AUTOMATED_REVIEWS.md

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================================================
# Option A: Review with Personal/Project Access Token (RECOMMENDED)
# ============================================================================
hodor-review:
  stage: test
  image:
    name: ghcr.io/mr-karan/hodor:latest
    entrypoint: [""]  # Override to allow shell commands

  variables:
    HODOR_MODEL: "anthropic/claude-sonnet-4-5-20250929"
    HODOR_VERBOSE: "false"

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

  before_script:
    # Authenticate glab with the personal/project access token
    # This allows Hodor to use glab for all GitLab API operations
    - glab auth login --hostname $CI_SERVER_HOST --token $GITLAB_TOKEN

  script:
    # Construct MR URL from GitLab CI variables
    - MR_URL="${CI_PROJECT_URL}/-/merge_requests/${CI_MERGE_REQUEST_IID}"
    - echo "üîç Reviewing MR: $MR_URL"

    # Run Hodor review (uses authenticated glab session)
    - |
      if [ "$HODOR_VERBOSE" = "true" ]; then
        hodor "$MR_URL" --model "$HODOR_MODEL" --post --verbose
      else
        hodor "$MR_URL" --model "$HODOR_MODEL" --post
      fi

  allow_failure: true
  timeout: 15m

# ============================================================================
# Option B: Review with CI Job Token (EXPERIMENTAL - NO TOKEN STORAGE)
# ============================================================================
# Uncomment this job and comment out 'hodor-review' above to use CI_JOB_TOKEN.
#
# Benefits:
# - No need to create or store tokens
# - Automatically rotated and scoped to the job
# - Better security (no long-lived credentials)
#
# Limitations:
# - Limited API endpoint support
# - May not work with all GitLab operations
# - Test thoroughly before production use
#
# hodor-review-job-token:
#   stage: test
#   image:
#     name: ghcr.io/mr-karan/hodor:latest
#     entrypoint: [""]
#
#   variables:
#     HODOR_MODEL: "anthropic/claude-sonnet-4-5-20250929"
#     HODOR_VERBOSE: "false"
#
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#
#   before_script:
#     # Authenticate glab with the CI job token
#     # This uses the automatically provided $CI_JOB_TOKEN
#     - glab auth login --hostname $CI_SERVER_HOST --job-token $CI_JOB_TOKEN
#
#   script:
#     - MR_URL="${CI_PROJECT_URL}/-/merge_requests/${CI_MERGE_REQUEST_IID}"
#     - echo "üîç Reviewing MR: $MR_URL"
#
#     # Run Hodor review (uses authenticated glab session)
#     - |
#       if [ "$HODOR_VERBOSE" = "true" ]; then
#         hodor "$MR_URL" --model "$HODOR_MODEL" --post --verbose
#       else
#         hodor "$MR_URL" --model "$HODOR_MODEL" --post
#       fi
#
#   allow_failure: true
#   timeout: 15m

# ============================================================================
# Optional Configurations
# ============================================================================

# Trigger review only when MR has specific label
# hodor-review-on-label:
#   extends: hodor-review
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /hodor-review/

# Manual trigger for cost control
# hodor-review-manual:
#   extends: hodor-review
#   when: manual

# Different models for different target branches
# hodor-review-main:
#   extends: hodor-review
#   variables:
#     HODOR_MODEL: "anthropic/claude-sonnet-4-20250514"  # Most thorough
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
#
# hodor-review-feature:
#   extends: hodor-review
#   variables:
#     HODOR_MODEL: "openai/gpt-5-2025-08-07"  # Fast and balanced
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "main"

# Only review specific file types
# hodor-review-code-only:
#   extends: hodor-review
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#       changes:
#         - "**/*.py"
#         - "**/*.js"
#         - "**/*.go"
#         - "**/*.rs"
